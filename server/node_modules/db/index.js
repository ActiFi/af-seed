var config = require('config');
var Sequelize = require("sequelize");
var fs        = require("fs");
var path      = require("path");
var _ = require('lodash');

var db = {};  // store database connections


//
// CONNECT TO DATABASE
console.log('Sequelize: Creating connection:');
var databaseURL = config.server.DATABASE_URL;
if(!databaseURL) throw new Error('No database configuration found.');

var options =  {
  define:{
    underscored: true,
    createdAt: 'createdOn',
    updatedAt: 'modifiedOn'
  }
};
var sequelize = new Sequelize(databaseURL, options);


//
// MODELS
var modelsDir = path.resolve(config.dirs.root, config.dirs.models);
console.log(modelsDir);
fs.readdirSync(modelsDir)
  .filter(function(file) {
    return (file.indexOf(".") !== 0) && (file !== "index.js");
  })
  .forEach(function(file) {
    var model = sequelize.import(path.join(modelsDir, file));
    db[model.name] = model;
  });
console.log('Models Loaded:(' + _.keys(db).join(', ')+')');

// loop object... handling associations
Object.keys(db).forEach(function(modelName) {
  if ("associate" in db[modelName]) {
    db[modelName].associate(db);
  }
});

// make sequelize easy to access
db.sequelize = sequelize;
db.Sequelize = Sequelize;

module.exports = db;

//module.exports = function(){
//
//  // already setup?
//  if(db) return db;
//  db = {};
//
//  //
//  // CONNECT TO DATABASE
//  console.log('Sequelize: Creating connection:');
//  var databaseURL = config.server.DATABASE_URL;
//  if(!databaseURL) throw new Error('No database configuration found.');
//
//  var options =  {
//    define:{createdAt: 'createdOn', updatedAt: 'modifiedOn'}
//  };
//  var sequelize = new Sequelize(databaseURL, options);
//
//
//  //
//  // MODELS
//  var modelsDir = path.resolve(config.dirs.root, config.dirs.models);
//  console.log(modelsDir);
//  fs.readdirSync(modelsDir)
//    .filter(function(file) {
//      return (file.indexOf(".") !== 0) && (file !== "index.js");
//    })
//    .forEach(function(file) {
//      var model = sequelize.import(path.join(modelsDir, file));
//      db[model.name] = model;
//    });
//  console.log('Models Loaded:(' + _.keys(db).join(', ')+')');
//
//  // loop object... handling associations
//  Object.keys(db).forEach(function(modelName) {
//    if ("associate" in db[modelName]) {
//      db[modelName].associate(db);
//    }
//  });
//
//  // make sequelize easy to access
//  db.sequelize = sequelize;
//  db.Sequelize = Sequelize;
//
//  return db;
//};